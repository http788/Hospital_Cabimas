<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Usuario - Hospital D' Empaire</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Paleta de Azules Claros (traída de login.html) */
        :root {
            --dark-blue: #0D47A1;
            --red-accent: #dc3545;
            --white: #ffffff;
            --dark-blue-form: #1565C0; /* No se usa para el fondo, pero sí para el texto */
            --dark-blue-input: #1E88E5;
            --blue-border: #42A5F5;
            --green-success: #28a745;
            
            /* --- Nuevos colores para el tema blanco --- */
            --color-texto-oscuro: #212121;
            --color-texto-secundario: #666;
            --color-fondo-input: #f4f4f4;
            --color-borde-input: #ccc;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 40px 20px; /* Padding para scroll en móvil */
            background-color: var(--dark-blue); /* <-- FONDO AZUL (Solicitado) */
            color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
        }

        /* Logo del Hospital (ELIMINADO DEL HTML) */
        
        /* Contenedor Principal del Formulario */
        .register-container {
            background-color: var(--white); /* <-- CUADRO BLANCO (Solicitado) */
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 650px; /* Más ancho para el registro */
            position: relative; 
            color: var(--color-texto-oscuro); /* <-- Texto oscuro por defecto */
        }

        /* Títulos */
        .register-container h1 {
            text-align: center;
            color: var(--dark-blue); /* <-- Texto azul oscuro */
            margin-top: 10px;
            margin-bottom: 25px;
            text-shadow: none; /* <-- Sin sombra de texto */
            font-size: 2em;
        }

        /* Estilos de los campos de entrada */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--color-texto-oscuro); /* <-- Texto oscuro */
        }

        /* Estilo general de inputs y selects */
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-borde-input); /* <-- Borde gris */
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-fondo-input); /* <-- Fondo gris claro */
            color: var(--color-texto-oscuro); /* <-- Texto oscuro */
            transition: border-color 0.3s;
            font-size: 1em;
        }
        input:focus, select:focus {
            border-color: var(--red-accent);
            outline: none;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.5); 
        }
        ::placeholder { color: var(--color-texto-secundario); opacity: 0.9; } /* <-- Placeholder gris */

        /* Layout de 2 Columnas */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Contenedor Cédula */
        .cedula-input-group {
            display: flex;
            align-items: center;
        }
        .cedula-input-group select {
            width: 60px;
            border-right: none;
            border-radius: 6px 0 0 6px;
        }
        .cedula-input-group input {
            flex-grow: 1; 
            border-radius: 0 6px 6px 0;
        }
        
        /* Contenedor Contraseña */
        .password-input-group {
            position: relative;
        }
        .password-input-group input {
            padding-right: 40px; 
            width: 100%;
            border-radius: 6px;
        }
        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-texto-secundario); /* <-- Icono gris */
            cursor: pointer;
            z-index: 10;
        }
        
        /* --- Requisitos de Contraseña --- */
        .password-reqs {
            list-style-type: none;
            padding: 0;
            margin: 10px 0;
            font-size: 0.9em;
            color: var(--color-texto-secundario); /* <-- Texto gris */
        }
        .password-reqs li {
            margin-bottom: 4px;
            transition: color 0.3s;
        }
        .password-reqs li.valid {
            color: var(--green-success); /* Verde (se mantiene) */
            text-decoration: line-through;
        }
        .password-reqs li i {
            margin-right: 8px;
            width: 15px;
        }
        .password-reqs li.valid .fa-times { display: none; }
        .password-reqs li:not(.valid) .fa-check { display: none; }


        /* Botón de Registro */
        .btn-submit {
            width: 100%;
            padding: 15px;
            background-color: var(--red-accent);
            color: var(--white);
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.4); 
            margin-top: 15px;
        }
        .btn-submit:hover {
            background-color: #bd2130; 
            transform: translateY(-3px); 
        }

        /* Flecha de Regreso */
        .back-arrow {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 28px;
            color: var(--red-accent); /* <-- Rojo sobre blanco (visible) */
            text-decoration: none;
        }
        .back-arrow:hover { color: #ff6b7b; }

        /* Mensajes de Error y Estado (de login.html) */
        .message {
            text-align: center;
            margin-top: 20px;
            padding: 12px;
            border-radius: 6px;
            font-weight: bold;
            display: none; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .error {
            background-color: #ffe0e6;
            color: var(--red-accent);
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        /* Enlace de Login */
        .login-link {
            text-align: center;
            margin-top: 25px;
            font-size: 1em;
            color: #555; /* <-- Texto gris oscuro */
        }
        .login-link a {
            color: var(--dark-blue); /* <-- Enlace azul */
            font-weight: bold;
            text-decoration: none;
        }
        
        /* Estilos de Campos de Doctor */
        .doctor-fields {
            padding: 20px;
            border: 1px dashed var(--dark-blue); /* <-- Borde azul */
            border-radius: 8px;
            margin-top: 20px;
            background-color: #f0f8ff; /* <-- Fondo azul muy claro */
        }
        .doctor-fields h3 {
            margin-top: 0;
            color: var(--dark-blue); /* <-- Título azul */
            border-bottom: 1px solid var(--color-borde-input); /* <-- Borde gris */
            padding-bottom: 10px;
        }
        .doctor-fields p {
            font-size: 0.85em;
            color: #444; /* <-- Texto oscuro */
            opacity: 1;
        }
        
        /* Responsive (Teléfono) */
        @media (max-width: 650px) {
            .register-container {
                padding: 20px 15px;
            }
            .form-row {
                grid-template-columns: 1fr; /* Apilar en móvil */
                gap: 0;
            }
            .form-group {
                margin-bottom: 15px;
            }
            /* Regla del logo eliminada */
            .register-container h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    
    <div class="register-container">
        
        <a href="login.html" class="back-arrow" title="Volver a Iniciar Sesión">
            &larr;
        </a>
        
        <h1>Registro de Usuario</h1>
        <form id="register-form">
            
            <div class="form-group">
                <label for="rol">Registrarme como:</label>
                <select id="rol" required>
                    <option value="Paciente">Paciente</option>
                    <option value="Doctor">Doctor</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="nombre">Nombre</label>
                    <input type="text" id="nombre" required>
                </div>
                <div class="form-group">
                    <label for="apellido">Apellido</label>
                    <input type="text" id="apellido" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="cedula">Cédula de Identidad</label>
                    <div class="cedula-input-group">
                        <select id="prefix" name="prefix">
                            <option value="V">V</option>
                            <option value="E">E</option>
                        </select>
                        <input type="text" id="cedula" name="cedula" required placeholder="Ej: 21555888">
                    </div>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="usuario@gmail.com">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <div class="password-input-group">
                        <input type="password" id="password" required>
                        <span class="toggle-password" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    
                    <ul class="password-reqs" id="password-reqs">
                        <li id="req-length"><i class="fas fa-times"></i><i class="fas fa-check"></i> Mínimo 8 caracteres</li>
                        <li id="req-upper"><i class="fas fa-times"></i><i class="fas fa-check"></i> Una mayúscula (A-Z)</li>
                        <li id="req-lower"><i class="fas fa-times"></i><i class="fas fa-check"></i> Una minúscula (a-z)</li>
                        <li id="req-number"><i class="fas fa-times"></i><i class="fas fa-check"></i> Un número (0-9)</li>
                        <li id="req-symbol"><i class="fas fa-times"></i><i class="fas fa-check"></i> Un símbolo (@$!%*?&)</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label for="password-confirm">Confirmar Contraseña</label>
                    <div class="password-input-group">
                        <input type="password" id="password-confirm" required>
                        <span class="toggle-password" id="togglePasswordConfirm">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    
                    <label for="telefono" style="margin-top: 15px;">Teléfono</label>
                    <input type="text" id="telefono" title="Ej: 04246012345" required placeholder="Ej: 04246012345">
                </div>
            </div>
            
            <div class="form-group">
                <label for="direccion_base">Dirección Base (Ciudad/Estado)</label>
                <input type="text" id="direccion_base" placeholder="Ej: Maracaibo, Zulia" required>
            </div>
            
            <div id="doctor-fields" class="doctor-fields" style="display: none;">
                <h3>Datos Profesionales del Doctor</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_colegiatura">Matrícula MPPS / ID Colegio</label>
                        <input type="text" id="id_colegiatura" placeholder="MPPS 123456"> 
                    </div>
                    <div class="form-group">
                        <label for="especialidad">Especialidad</label>
                        <select id="especialidad">
                            </select>
                    </div>
                </div>
                <p>
                    * Su cuenta de Doctor estará en estado **PENDIENTE** hasta que el Administrador la active.
                </p>
            </div>

            <button type="submit" class="btn-submit">Registrar Cuenta</button>
        </form>
        
        <div id="message-area" class="message"></div>

        <div class="login-link">
            <p>¿Ya tienes una cuenta? <a href="login.html">¡Inicia Sesión aquí!</a></p>
        </div>
    </div>

    <script>
        // --- MODIFICADO: API Relativa ---
        const API_BASE = '/api/auth/register'; 
        const API_PUBLIC = '/api/public'; // Para especialidades

        document.addEventListener('DOMContentLoaded', () => {
            const rolSelect = document.getElementById('rol');
            const doctorFields = document.getElementById('doctor-fields');
            const matriculaInput = document.getElementById('id_colegiatura');
            const especialidadSelect = document.getElementById('especialidad');
            const registerForm = document.getElementById('register-form');
            const messageArea = document.getElementById('message-area');
            
            const passwordInput = document.getElementById('password');
            const passwordConfirmInput = document.getElementById('password-confirm');
            const reqs = {
                length: document.getElementById('req-length'),
                upper: document.getElementById('req-upper'),
                lower: document.getElementById('req-lower'),
                number: document.getElementById('req-number'),
                symbol: document.getElementById('req-symbol'),
            };
            const regex = {
                upper: /[A-Z]/,
                lower: /[a-z]/,
                number: /[0-9]/,
                symbol: /[@$!%*?&]/
            };

            // --- Lógica de Toggle de Campos de Doctor ---
            function toggleDoctorFields() {
                const isDoctor = rolSelect.value === 'Doctor';
                doctorFields.style.display = isDoctor ? 'block' : 'none';
                matriculaInput.required = isDoctor;
                especialidadSelect.required = isDDoctor;
                if (!isDoctor) {
                    matriculaInput.value = '';
                    especialidadSelect.value = '';
                }
            }
            
            // --- Cargar Especialidades (Profesional) ---
            async function loadEspecialidades() {
                try {
                    const response = await fetch(`${API_PUBLIC}/especialidades`);
                    if (!response.ok) throw new Error('No se pudieron cargar especialidades');
                    const especialidades = await response.json();
                    
                    especialidadSelect.innerHTML = '<option value="">Seleccione...</option>';
                    especialidades.forEach(nombre => {
                        especialidadSelect.innerHTML += `<option value="${nombre}">${nombre}</option>`;
                    });
                } catch (error) {
                    console.error(error);
                    especialidadSelect.innerHTML = '<option value="">Error al cargar</option>';
                }
            }

            // --- Lógica de Toggle de Contraseña ---
            function setupPasswordToggle(toggleId, inputId) {
                document.getElementById(toggleId).addEventListener('click', function () {
                    const input = document.getElementById(inputId);
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    this.querySelector('i').classList.toggle('fa-eye');
                    this.querySelector('i').classList.toggle('fa-eye-slash');
                });
            }
            setupPasswordToggle('togglePassword', 'password');
            setupPasswordToggle('togglePasswordConfirm', 'password-confirm');
            
            // --- Lógica de Validación de Contraseña en Tiempo Real ---
            let passwordValid = false;
            passwordInput.addEventListener('keyup', () => {
                const pass = passwordInput.value;
                let validCount = 0;
                
                // 8 caracteres
                if (pass.length >= 8) { reqs.length.classList.add('valid'); validCount++; } 
                else { reqs.length.classList.remove('valid'); }
                
                // Mayúscula
                if (regex.upper.test(pass)) { reqs.upper.classList.add('valid'); validCount++; }
                else { reqs.upper.classList.remove('valid'); }
                
                // Minúscula
                if (regex.lower.test(pass)) { reqs.lower.classList.add('valid'); validCount++; }
                else { reqs.lower.classList.remove('valid'); }
                
                // Número
                if (regex.number.test(pass)) { reqs.number.classList.add('valid'); validCount++; }
                else { reqs.number.classList.remove('valid'); }
                
                // Símbolo
                if (regex.symbol.test(pass)) { reqs.symbol.classList.add('valid'); validCount++; }
                else { reqs.symbol.classList.remove('valid'); }
                
                passwordValid = (validCount === 5);
            });
            
            // --- Lógica de Feedback ---
            function showFeedback(message, type) {
                messageArea.className = `message ${type}`;
                messageArea.textContent = message;
                messageArea.style.display = 'block';
            }

            // --- Lógica de Envío de Formulario ---
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                messageArea.style.display = 'none'; // Ocultar mensaje anterior

                // 1. Validaciones Previas
                if (!passwordValid) {
                    showFeedback('Error: La contraseña no cumple todos los requisitos.', 'error');
                    passwordInput.focus();
                    return;
                }
                if (passwordInput.value !== passwordConfirmInput.value) {
                    showFeedback('Error: Las contraseñas no coinciden.', 'error');
                    passwordConfirmInput.focus();
                    return;
                }

                // 2. Recolección de Datos
                const rol = rolSelect.value;
                const data = {
                    rol,
                    cedula: document.getElementById('prefix').value + document.getElementById('cedula').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    password: passwordInput.value,
                    nombre: document.getElementById('nombre').value.trim(),
                    apellido: document.getElementById('apellido').value.trim(),
                    telefono: document.getElementById('telefono').value.trim(),
                    direccion_base: document.getElementById('direccion_base').value.trim(),
                };

                if (rol === 'Doctor') {
                    data.id_colegiatura = matriculaInput.value.trim();
                    data.especialidad = especialidadSelect.value;
                    if (!data.id_colegiatura || !data.especialidad) {
                        showFeedback('Error: Complete los campos de Matrícula y Especialidad.', 'error');
                        return;
                    }
                }
                
                showFeedback('Procesando registro...', 'success');

                // 3. Envío a la API
                try {
                    const response = await fetch(API_BASE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                    const result = await response.json();

                    if (response.ok) {
                        
                        // --- INICIO DE MODIFICACIÓN (Solicitado) ---
                        let successMessage;
                        if (rol === 'Doctor') {
                            successMessage = '¡Registro exitoso! Su cuenta está pendiente de activación.';
                        } else {
                            successMessage = result.msg; // "Registro exitoso."
                        }
                        
                        showFeedback(successMessage + ' Redirigiendo al inicio de sesión...', 'success');
                        // --- FIN DE MODIFICACIÓN ---
                        
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 3000);
                    } else {
                        showFeedback('Error: ' + (result.msg || 'Intente de nuevo.'), 'error');
                    }
                } catch (error) {
                    console.error('Error de red:', error);
                    showFeedback('Error de conexión con el servidor.', 'error');
                }
            });
            
            // --- Inicialización ---
            toggleDoctorFields();
            loadEspecialidades(); // Cargar especialidades al iniciar
            rolSelect.addEventListener('change', toggleDoctorFields);
        });
    </script>
</body>
</html>
